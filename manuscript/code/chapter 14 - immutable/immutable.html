<html>
  <head>
    <script type="text/javascript" src="immutable.min.js"></script>
    <script type="text/javascript" src="d3.v3.min.js"></script>
    <script type="text/javascript" src="numeric-1.2.6.min.js"></script>
    <script type="text/javascript" src="underscore-min.js"></script>
    <script type="text/javascript" src="jstat.min.js"></script>
  </head>
  <script>
    "use strict";
    var quandlApiKey = "";
  </script>
  <script type="text/javascript" src="quandl-api-key.js"></script>
  <script>
    "use strict";

    //do something big with lo-dash

    //calc time between two approaches
    var map1 = Immutable.Map({a:1, b:2, c:3});
    var map2 = map1.set('b', 50);
    map1.get('b'); // 2
    map2.get('b'); // 50

    console.log(map1.toJS(), map2.toJS());

    _.prototype.getReturns = function()
        {
        const before = this.rest().value();
        const after = this.initial().value();


        const returns = numeric.log( numeric['/'](after, before) );

        const mean = jStat(returns).mean();

        return numeric['-'](returns, mean);
        }

    const getAutocorrelations = returns =>
      _.chain( _.range(1008) )
        //reduce - take n-1, n-2, ..., n-20
        .reduce(
          (a, c, _, arr) =>
            a.length >= arr.length ?
              a
              :
              a.concat(
                [ returns.slice( c, returns.length ) ]
                )
          , []
          )
        //reduce auto-correlations between 0,1; 0,2; 0,3 etc.
        .reduce(
          (a,c) =>
            a.base === null ?
              ({base: c, correlations: []})
              :
              ({
                base: a.base
                , correlations: a.correlations.concat(
                  jStat.corrcoeff(
                    a.base.slice(0,c.length)
                    , c
                    )
                  )
                })
          , {base: null, correlations: []}
          )
        .value()
        //only return correlations
        .correlations;

    const postBox = function*(previousResults){
      const data = yield;

      //calc returns
      const returns = _.chain(data)
        .pluck("Adj Close")
        .map( x => +x )
        .getReturns();

      //demean returns b4 calc'ing anything else


      //autocorrelations over time
      //generate array from 1 to 252
      const result = getAutocorrelations(returns);

      console.log(result);

      //normal version
      //immutable version

      yield* postBox(returns)
      }

    //init
    //request 253 prices
    const send = postBox([]);
    send.next();

    const pullData =
      (ticker, quandlApiKey) =>
        d3.csv( "https://www.quandl.com/api/v3/datasets/YAHOO/"+ticker+".csv?auth_token="+quandlApiKey,
          data => send.next( data )
          )

    pullData("INDEX_GSPC", quandlApiKey);
  </script>
</html>
