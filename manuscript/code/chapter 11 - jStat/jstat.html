<html>
<head>
        <script type="text/javascript" src="jstat.min.js"></script>
        <script type="text/javascript" src="d3.v3.min.js"></script>
        <script type="text/javascript" src="https://cdn.plot.ly/plotly-latest.min.js"></script>
        <script type="text/javascript" src="quandl-api-key.js"></script>
</head>
<body>
        <div id='graph'></div>
</body>
<script>
        var quandlApiKey = "";
</script>
<script type="text/javascript" src="quandl-api-key.js"></script>
<script>
        "use strict";

        //accumulate data and plot
        const postBox = function*(){
                const priceData = yield;
                
                //calc returns
                const returns = priceData
                        .sort( (a,b) => a.Date > b.Date )
                        .reduce(
                                (a,c) =>
                                        a.previousPrice === null ?
                                                { returns: [], previousPrice: c.Close }
                                                :
                                                {
                                                returns: a.returns.concat( { date: c.Date, return: Math.log( c.Close / a.previousPrice ) } ),
                                                previousPrice: c.Close
                                                }
                                        , { returns: [], previousPrice: null }
                                )
                        .returns
                        .sort( (a,b) => a.return > b.return );
                
                const rs = returns.map(r => r.return);
                
                const sd = jStat(rs).stdev(true);
                const dof = 3

                //calc t stats
                const results = returns
                        .reduce(
                                ( previousValue, currentValue, currentIndex, array ) =>
                                        {
                                        currentValue.t =
                                                jStat.studentt.inv( ( currentIndex + 1 ) / ( array.length + 1 ), previousValue.dof ) * 
                                                previousValue.sd * 
                                                Math.sqrt( ( previousValue.dof - 2 ) / previousValue.dof );
                                        
                                        currentValue.n =
                                                jStat.normal.inv(
                                                        ( currentIndex + 1 ) / ( array.length + 1 ),
                                                        0,
                                                        previousValue.sd
                                                        );
                                        
                                        return {results: previousValue.results.concat(currentValue),
                                                sd: previousValue.sd,
                                                dof: previousValue.dof
                                                };
                                        }
                                        , {     results: [],
                                                sd: sd, 
                                                dof: dof
                                                }
                                )
                        .results;
                
                const ts = results.map(t => t.t);
                const r2t = Math.pow( jStat.corrcoeff(rs,ts), 2);
                
                console.log(r2t);
                
                const ns = results.map(t => t.n);
                const r2n = Math.pow( jStat.corrcoeff(rs,ns), 2);
                
                console.log(r2n);
                
                
                
                
                const graphDiv = document.getElementById('graph');
                
                const trace = {
                                x: ts,
                                y: rs
                                };
                
                const trace1 = {
                                x: ns,
                                y: rs
                                };
                
                const layout = {
                        title: "Euro Dollar Term Structure",
                        xaxis: { title:"t stat" },
                        yaxis: { title:"returns" }
                        };
                        
                Plotly.newPlot( 
                        graphDiv, 
                        [ trace, trace1 ],
                        layout
                        );
                
                
                }
        
        //init
        const send = postBox();
        send.next();
        
        //download data
        d3.csv( "https://www.quandl.com/api/v3/datasets/YAHOO/INDEX_GSPC.csv?auth_token="+quandlApiKey, 
                data => send.next( data ) 
                )
</script>
</html>
