<html>
  <head>
    <script type="text/javascript" src="immutable.min.js"></script>
    <script type="text/javascript" src="d3.v3.min.js"></script>
    <script type="text/javascript" src="lodash.js"></script>
  </head>
  <script>
    "use strict";
    var quandlApiKey = "";
  </script>
  <script type="text/javascript" src="quandl-api-key.js"></script>
  <script>
    "use strict";
    //how to get monoids/plugs from underscore / etc. chains?
    //es2015 maps vs immutable maps?

    //equality check - portfolio check for recalculation
    //copy over - changing holdings / parameters etc
    //no defensive copying - weird javascript object / scope problems...

    //portfolio
    //check whether object/position has changed
    //have list of calc'ed positions
    //if find a new position then recalc'

    //or...
    //single position
    //check for changing t&cs or mkt data
    //once changed, reprice security
    //security is imm
    //security depends upons mkt data & t&cs
    //how does react do it...

    //do & undo stacks
    //pop and push as we move thru history

    //react does reconciliation
    //it sees what's changed
    //and updates - how does this work?


    //transactions
    //reconciliation against holdings

    //portfolio - list of securities

    //*******
    //immutable analogy - tracking transactions at a point of time instead of tracking holdings
    const convertToImmutableList = data =>
      Immutable
        .List(data)
        .map( x =>
          new Immutable.Map(
            {
            Date: x.Date,
            Symbol: x.Symbol,
            Issue_Description: x.Issue_Description,
            Transaction: +x.Transaction
            }
            )
          );

    const update = (convertedData, previousTotal) =>
      convertedData.reduce(
        (accumulant, row) =>
          //check whether symbol has already been inserted
          accumulant.get( row.get( "Symbol" ) ) === undefined ?
            accumulant.set(
              row.get( "Symbol" )
              , row.get("Transaction")
              )
            :
            accumulant.set(
              row.get( "Symbol" )
              , row.get("Transaction") +
                accumulant.get(
                  row.get( "Symbol" )
                  )
             )
        , previousTotal
        )

    //read cppib csv / realtime markit feed?
    const postBox = function*(history){
      const groupedData = _.chain(yield).groupBy("Date");
      const updatedHistory = groupedData
        .keys()
        .value()
        .reduce(
          (a,k) =>
            a.push(
              update(
                convertToImmutableList(
                  groupedData.value()[k]
                  )
                , a.last()
                )
              )
            , history
          )
      console.log( updatedHistory.toJS() );
      return updatedHistory;
      }

    //init
    const init = Immutable.List( [ Immutable.Map( {} ) ] );
    const send = postBox(init);
    send.next();

    //ticker
    const pullData =
      _ =>
        d3.csv( "data/transactions_commas.csv",
          data => send.next( data )
          )

    pullData();

  </script>
</html>
