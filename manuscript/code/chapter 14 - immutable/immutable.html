<html>
  <head>
    <script type="text/javascript" src="immutable.min.js"></script>
    <script type="text/javascript" src="d3.v3.min.js"></script>
    <script type="text/javascript" src="numeric-1.2.6.min.js"></script>
    <script type="text/javascript" src="lodash.js"></script>
    <script type="text/javascript" src="jstat.min.js"></script>
  </head>
  <script>
    "use strict";
    var quandlApiKey = "";
  </script>
  <script type="text/javascript" src="quandl-api-key.js"></script>
  <script>
    "use strict";


    //how to get monoids/plugs from underscore / etc. chains?
    //es2015 maps vs immutable maps?

    //equality check - portfolio check for recalculation
    //copy over - changing holdings / parameters etc
    //no defensive copying - weird javascript object / scope problems...


    _.prototype.getReturns = function()
        {
        const before = this.rest().value();
        const after = this.initial().value();

        const returns = numeric.log( numeric['/'](after, before) );

        const mean = jStat(returns).mean();

        //demean returns b4 calc'ing anything else
        return numeric['-'](returns, mean);
        }

    Array.prototype.getAutocorrelations = function(n){
      return _.chain( _.range(n) )
        //reduce - take n-1, n-2, ..., n-20
        .reduce(
          (a, c, _, arr) =>
            a.length >= arr.length ?
              a
              :
              a.concat(
                [ this.slice( c, n ) ]
                )
          , []
          )
        //reduce auto-correlations between 0,1; 0,2; 0,3 etc.
        .reduce(
          (a,c) =>
            a.base === null ?
              ({base: c, correlations: []})
              :
              ({
                base: a.base
                , correlations: a.correlations.concat(
                  jStat.corrcoeff(
                    a.base.slice(0,c.length)
                    , c
                    )
                  )
                })
          , {base: null, correlations: []}
          )
        .value()
        //only return correlations
        .correlations;
      }

    Array.prototype.groupedReturns = function(){
      return _.chain(this).reduce(
        (a,c) =>
          a.concat( [ a[a.length-1].concat(c) ] )
        , [[]]
        )
        .value();
      }


    const postBox = function*(previousResults){
      var data = yield;

      var data0 = Immutable.List(data);

      console.time("timer");

      var data1 = data0.concat(data);
      var data2 = data1.concat(data);
      var data3 = data2.concat(data);
      var data4 = data3.concat(data);
      var data5 = data4.concat(data);

      console.timeEnd("timer");
      console.log("5 "+data5.length);
      console.log("5 "+data0.length);

      }

    //init
    //request 253 prices
    const send = postBox([]);
    send.next();

    const pullData =
      (ticker, quandlApiKey) =>

        d3.csv( "YAHOO-INDEX_GSPC.csv",
        //d3.csv( "https://www.quandl.com/api/v3/datasets/YAHOO/"+ticker+".csv?auth_token="+quandlApiKey,
          data => send.next( data )
          )

    //pullData("INDEX_GSPC", quandlApiKey);



    const n = 1000000;

    var a =
      _.chain( _.range(n) )
      .map(x => Math.random())
      .value();


    console.time("timer_imm");

      console.time("timer_imm_1");
        const orig = Immutable.List(a);
      console.timeEnd("timer_imm_1");

      console.time("timer_imm_2");
        console.log("add 1 to array");
        const orig_push = orig.push(1);
      console.timeEnd("timer_imm_2");

      console.time("timer_imm_3");
        console.log("check whether changed and 'orig' is equal");
        console.log(Immutable.is(orig, orig_push));
      console.timeEnd("timer_imm_3");


      console.time("timer_imm_4");
        console.log("pop out previous change");
        const orig_push_pop = orig_push.pop();
      console.timeEnd("timer_imm_4");


      console.time("timer_imm_5");
        console.log("check whether change and 'undo' results in same state");
        console.log( Immutable.is(orig_push_pop, orig) );
      console.timeEnd("timer_imm_5");

    console.timeEnd("timer_imm");



    console.time("timer_mut_ld");

      var m_orig = _.cloneDeep(a);

      console.log("add 1 to array");
      var m_orig_push = m_orig.concat(1);

      console.log("check whether changed and 'orig' is equal");
      console.log(_.isEqual(m_orig, m_orig_push));

      console.log("pop out previous change");
      var m_orig_push_pop = _.initial(m_orig_push );

      console.log("check whether change and 'undo' results in same state");
      console.log( _.isEqual(m_orig, m_orig_push_pop) );

    console.timeEnd("timer_mut_ld");



    console.time("timer_mut");


    console.timeEnd("timer_mut");




  </script>
</html>
